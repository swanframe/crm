<!-- templates/reservations.html -->
{% extends "dashboard.html" %}

{% block title %}{{ _('reservations.management_title') }} - {{ _('app_name') }}{% endblock %}

{% block page_title %}{{ _('reservations.management_title') }}{% endblock %}

{% block page_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">{{ _('sidebar.reservations') }}</h1>
    <div class="d-flex align-items-center">
        <form class="d-flex me-3" method="GET" action="{{ url_for('list_reservations') }}">
            <input class="form-control me-2" type="search" placeholder="{{ _('common.search_placeholder', entity_name=_('sidebar.reservations')) }}" aria-label="Search" name="search" value="{{ search_query if search_query }}">
            <button class="btn btn-outline-success" type="submit"><i class="bi bi-search"></i></button>
            {# Hidden fields to preserve sort state during search #}
            <input type="hidden" name="sort_by" value="{{ sort_by }}">
            <input type="hidden" name="sort_order" value="{{ sort_order }}">
        </form>
        {% if g.user.user_level in ['Admin', 'Operator', 'Contributor'] %} {# Admin, Operator, Contributor can add reservations #}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReservationModal">
            <i class="bi bi-plus-circle me-2"></i>{{ _('common.add_new', entity_name=_('sidebar.reservations')) }}
        </button>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        {# Sortable Column: ID #}
                        <th>
                            <a href="{{ url_for('list_reservations', page=page, search=search_query, sort_by='reservation_id', sort_order='asc' if sort_by != 'reservation_id' or sort_order == 'desc' else 'desc') }}" class="text-decoration-none text-dark">
                                {{ _('common.id') }}
                                {% if sort_by == 'reservation_id' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="bi bi-caret-up-fill" aria-label="{{ _('common.sorted_ascending') }}"></i>
                                    {% else %}
                                        <i class="bi bi-caret-down-fill" aria-label="{{ _('common.sorted_descending') }}"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        {# Sortable Column: Customer Name #}
                        <th>
                            <a href="{{ url_for('list_reservations', page=page, search=search_query, sort_by='customer_name', sort_order='asc' if sort_by != 'customer_name' or sort_order == 'desc' else 'desc') }}" class="text-decoration-none text-dark">
                                {{ _('customers.customer_name') }}
                                {% if sort_by == 'customer_name' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="bi bi-caret-up-fill" aria-label="{{ _('common.sorted_ascending') }}"></i>
                                    {% else %}
                                        <i class="bi bi-caret-down-fill" aria-label="{{ _('common.sorted_descending') }}"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        {# Sortable Column: Store Name #}
                        <th>
                            <a href="{{ url_for('list_reservations', page=page, search=search_query, sort_by='store_name', sort_order='asc' if sort_by != 'store_name' or sort_order == 'desc' else 'desc') }}" class="text-decoration-none text-dark">
                                {{ _('stores.store_name') }}
                                {% if sort_by == 'store_name' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="bi bi-caret-up-fill" aria-label="{{ _('common.sorted_ascending') }}"></i>
                                    {% else %}
                                        <i class="bi bi-caret-down-fill" aria-label="{{ _('common.sorted_descending') }}"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        {# Sortable Column: Reservation Datetime #}
                        <th>
                            <a href="{{ url_for('list_reservations', page=page, search=search_query, sort_by='reservation_datetime', sort_order='asc' if sort_by != 'reservation_datetime' or sort_order == 'desc' else 'desc') }}" class="text-decoration-none text-dark">
                                {{ _('reservations.reservation_datetime') }}
                                {% if sort_by == 'reservation_datetime' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="bi bi-caret-up-fill" aria-label="{{ _('common.sorted_ascending') }}"></i>
                                    {% else %}
                                        <i class="bi bi-caret-down-fill" aria-label="{{ _('common.sorted_descending') }}"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        {# Sortable Column: Status #}
                        <th>
                            <a href="{{ url_for('list_reservations', page=page, search=search_query, sort_by='reservation_status', sort_order='asc' if sort_by != 'reservation_status' or sort_order == 'desc' else 'desc') }}" class="text-decoration-none text-dark">
                                {{ _('reservations.reservation_status') }}
                                {% if sort_by == 'reservation_status' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="bi bi-caret-up-fill" aria-label="{{ _('common.sorted_ascending') }}"></i>
                                    {% else %}
                                        <i class="bi bi-caret-down-fill" aria-label="{{ _('common.sorted_descending') }}"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>{{ _('common.actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reservation in reservations %}
                    <tr>
                        <td>{{ reservation.reservation_id }}</td>
                        <td>{{ reservation.get_customer_name() }}</td>
                        <td>{{ reservation.get_store_name() }}</td>
                        <td>{{ reservation.reservation_datetime.strftime('%Y-%m-%d %H:%M') if reservation.reservation_datetime else _('common.not_available_short') }}</td>
                        <td>
                            <span class="badge bg-{{ {
                                'Pending': 'warning',
                                'Confirmed': 'success',
                                'Cancelled': 'danger',
                                'Completed': 'info'
                            }[reservation.reservation_status] | default('secondary') }}">
                                {{ _('reservation_statuses.' + reservation.reservation_status) }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('view_reservation_detail', reservation_id=reservation.reservation_id) }}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-eye"></i> {{ _('common.view') }}
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">{{ _('common.no_records_found', entity_name=_('sidebar.reservations')) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination Controls -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('list_reservations', page=1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}" aria-label="{{ _('common.first_page') }}">
                <span aria-hidden="true">&laquo;&laquo;</span>
            </a>
        </li>
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('list_reservations', page=page-1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}" aria-label="{{ _('common.previous_page') }}">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        
        {% set pages_to_show = 5 %} {# Number of pages to show around the current page #}
        {% set start_page = [1, page - (pages_to_show // 2)] | max %}
        {% set end_page = [total_pages, page + (pages_to_show // 2)] | min %}

        {% if start_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('list_reservations', page=1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}">1</a>
            </li>
            {% if start_page > 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('list_reservations', page=p, search=search_query, sort_by=sort_by, sort_order=sort_order) }}">{{ p }}</a>
            </li>
        {% endfor %}

        {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('list_reservations', page=total_pages, search=search_query, sort_by=sort_by, sort_order=sort_order) }}">{{ total_pages }}</a>
            </li>
        {% endif %}

        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('list_reservations', page=page+1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}" aria-label="{{ _('common.next_page') }}">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('list_reservations', page=total_pages, search=search_query, sort_by=sort_by, sort_order=sort_order) }}" aria-label="{{ _('common.last_page') }}">
                <span aria-hidden="true">&raquo;&raquo;</span>
            </a>
        </li>
    </ul>
</nav>

<!-- Add Reservation Modal -->
<div class="modal fade" id="addReservationModal" tabindex="-1" aria-labelledby="addReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_reservation') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addReservationModalLabel">{{ _('reservations.add_modal_title') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('common.close_button') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_customer_search" class="form-label">{{ _('customers.customer_name') }}</label>
                        <input type="text" class="form-control" id="add_customer_search" 
                               placeholder="{{ _('reservations.search_customer_placeholder') }}" autocomplete="off" required>
                        <input type="hidden" id="add_customer_id_hidden" name="customer_id" required>
                        <div id="add_customer_suggestions" class="list-group position-absolute w-100" style="z-index: 1051;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="add_store_id" class="form-label">{{ _('stores.store_name') }}</label>
                        <select class="form-select" id="add_store_id" name="store_id" required>
                            <option value="">{{ _('common.select_placeholder', entity_name=_('sidebar.stores')) }}</option>
                            {% for store in all_stores %}
                                <option value="{{ store.store_id }}">{{ store.store_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add_reservation_datetime" class="form-label">{{ _('reservations.reservation_datetime') }}</label>
                        <input type="datetime-local" class="form-control" id="add_reservation_datetime" name="reservation_datetime" required>
                    </div>
                    {# NEW: reservation_event field #}
                    <div class="mb-3">
                        <label for="add_reservation_event" class="form-label">{{ _('reservations.reservation_event') }}</label>
                        <input type="text" class="form-control" id="add_reservation_event" name="reservation_event">
                    </div>
                    {# NEW: reservation_room field #}
                    <div class="mb-3">
                        <label for="add_reservation_room" class="form-label">{{ _('reservations.reservation_room') }}</label>
                        <input type="text" class="form-control" id="add_reservation_room" name="reservation_room">
                    </div>
                    {# NEW: reservation_guests field #}
                    <div class="mb-3">
                        <label for="add_reservation_guests" class="form-label">{{ _('reservations.reservation_guests') }}</label>
                        <input type="number" class="form-control" id="add_reservation_guests" name="reservation_guests" min="1">
                    </div>
                    <div class="mb-3">
                        <label for="add_reservation_status" class="form-label">{{ _('reservations.reservation_status') }}</label>
                        <select class="form-select" id="add_reservation_status" name="reservation_status" required>
                            <option value="Pending">{{ _('reservation_statuses.Pending') }}</option>
                            <option value="Confirmed">{{ _('reservation_statuses.Confirmed') }}</option>
                            <option value="Cancelled">{{ _('reservation_statuses.Cancelled') }}</option>
                            <option value="Completed">{{ _('reservation_statuses.Completed') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add_reservation_notes" class="form-label">{{ _('reservations.reservation_notes') }}</label>
                        <textarea class="form-control" id="add_reservation_notes" name="reservation_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.close_button') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('common.add_new', entity_name=_('sidebar.reservations')) }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editReservationForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="editReservationModalLabel">{{ _('reservations.edit_modal_title') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('common.close_button') }}"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_reservation_id" name="reservation_id">
                    <div class="mb-3">
                        <label for="edit_customer_search" class="form-label">{{ _('customers.customer_name') }}</label>
                        <input type="text" class="form-control" id="edit_customer_search" 
                               placeholder="{{ _('reservations.search_customer_placeholder') }}" autocomplete="off" required>
                        <input type="hidden" id="edit_customer_id_hidden" name="customer_id" required>
                        <div id="edit_customer_suggestions" class="list-group position-absolute w-100" style="z-index: 1051;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_store_id" class="form-label">{{ _('stores.store_name') }}</label>
                        <select class="form-select" id="edit_store_id" name="store_id" required>
                            <option value="">{{ _('common.select_placeholder', entity_name=_('sidebar.stores')) }}</option>
                            {% for store in all_stores %}
                                <option value="{{ store.store_id }}">{{ store.store_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_reservation_datetime" class="form-label">{{ _('reservations.reservation_datetime') }}</label>
                        <input type="datetime-local" class="form-control" id="edit_reservation_datetime" name="reservation_datetime" required>
                    </div>
                    {# NEW: reservation_event field for edit modal #}
                    <div class="mb-3">
                        <label for="edit_reservation_event" class="form-label">{{ _('reservations.reservation_event') }}</label>
                        <input type="text" class="form-control" id="edit_reservation_event" name="reservation_event">
                    </div>
                    {# NEW: reservation_room field for edit modal #}
                    <div class="mb-3">
                        <label for="edit_reservation_room" class="form-label">{{ _('reservations.reservation_room') }}</label>
                        <input type="text" class="form-control" id="edit_reservation_room" name="reservation_room">
                    </div>
                    {# NEW: reservation_guests field for edit modal #}
                    <div class="mb-3">
                        <label for="edit_reservation_guests" class="form-label">{{ _('reservations.reservation_guests') }}</label>
                        <input type="number" class="form-control" id="edit_reservation_guests" name="reservation_guests" min="1">
                    </div>
                    <div class="mb-3">
                        <label for="edit_reservation_status" class="form-label">{{ _('reservations.reservation_status') }}</label>
                        <select class="form-select" id="edit_reservation_status" name="reservation_status" required>
                            <option value="Pending">{{ _('reservation_statuses.Pending') }}</option>
                            <option value="Confirmed">{{ _('reservation_statuses.Confirmed') }}</option>
                            <option value="Cancelled">{{ _('reservation_statuses.Cancelled') }}</option>
                            <option value="Completed">{{ _('reservation_statuses.Completed') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_reservation_notes" class="form-label">{{ _('reservations.reservation_notes') }}</label>
                        <textarea class="form-control" id="edit_reservation_notes" name="reservation_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('common.close_button') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('common.save_changes_button') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Utility function for debouncing
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Function to handle customer search and populate suggestions
    function setupCustomerSearch(searchInputId, hiddenInputId, suggestionsDivId) {
        const searchInput = document.getElementById(searchInputId);
        const hiddenInput = document.getElementById(hiddenInputId);
        const suggestionsDiv = document.getElementById(suggestionsDivId);

        if (!searchInput || !hiddenInput || !suggestionsDiv) {
            console.error('One or more elements not found for customer search setup:', { searchInputId, hiddenInputId, suggestionsDivId });
            return;
        }

        const fetchCustomers = debounce(async (query) => {
            if (query.length < 2) { // Only search if query is at least 2 characters long
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/customers/search?q=${encodeURIComponent(query)}`);
                const customers = await response.json();
                
                suggestionsDiv.innerHTML = ''; // Clear previous suggestions
                if (customers.length > 0) {
                    customers.forEach(customer => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.classList.add('list-group-item', 'list-group-item-action');
                        item.textContent = `${customer.name} (ID: ${customer.id}, Code: ${customer.code}, Tel: ${customer.telephone})`;
                        item.setAttribute('data-customer-id', customer.id);
                        item.setAttribute('data-customer-name', customer.name);
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            searchInput.value = customer.name;
                            hiddenInput.value = customer.id;
                            suggestionsDiv.innerHTML = '';
                            suggestionsDiv.style.display = 'none';
                        });
                        suggestionsDiv.appendChild(item);
                    });
                    suggestionsDiv.style.display = 'block'; // Show suggestions
                } else {
                    suggestionsDiv.style.display = 'none'; // Hide if no results
                }
            } catch (error) {
                console.error('Error fetching customers:', error);
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.style.display = 'none';
            }
        }, 300); // 300ms debounce delay

        searchInput.addEventListener('input', (e) => {
            fetchCustomers(e.target.value);
            // Clear hidden ID if text input changes (user might be typing a new customer)
            if (hiddenInput.value && searchInput.value !== (searchInput.dataset.selectedCustomerName || '')) {
                hiddenInput.value = '';
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.style.display = 'none';
            }
        });

        // When the modal is hidden, clear the search input and hidden ID
        const modal = searchInput.closest('.modal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', () => {
                searchInput.value = '';
                hiddenInput.value = '';
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.style.display = 'none';
                delete searchInput.dataset.selectedCustomerName; // Clear stored name
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Setup for Add Reservation Modal
        setupCustomerSearch('add_customer_search', 'add_customer_id_hidden', 'add_customer_suggestions');

        // Setup for Edit Reservation Modal
        setupCustomerSearch('edit_customer_search', 'edit_customer_id_hidden', 'edit_customer_suggestions');

        // Script to populate data in the edit modal
        var editReservationModal = document.getElementById('editReservationModal');
        editReservationModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            var reservationId = button.getAttribute('data-reservation-id');
            var customerId = button.getAttribute('data-customer-id');
            var storeId = button.getAttribute('data-store-id');
            var reservationDatetime = button.getAttribute('data-reservation-datetime');
            var reservationStatus = button.getAttribute('data-reservation-status');
            var reservationNotes = button.getAttribute('data-reservation-notes');
            var customerName = button.getAttribute('data-customer-name'); // For modal title and pre-filling search input
            // NEW: Get new optional fields
            var reservationEvent = button.getAttribute('data-reservation-event');
            var reservationRoom = button.getAttribute('data-reservation-room');
            var reservationGuests = button.getAttribute('data-reservation-guests');


            var modalTitle = editReservationModal.querySelector('.modal-title');
            var modalBodyInputId = editReservationModal.querySelector('#edit_reservation_id');
            var modalBodyInputCustomerSearch = editReservationModal.querySelector('#edit_customer_search'); // New search input
            var modalBodyInputCustomerIdHidden = editReservationModal.querySelector('#edit_customer_id_hidden'); // Hidden ID
            var modalBodySelectStoreId = editReservationModal.querySelector('#edit_store_id');
            var modalBodyInputDatetime = editReservationModal.querySelector('#edit_reservation_datetime');
            var modalBodySelectStatus = editReservationModal.querySelector('#edit_reservation_status');
            var modalBodyTextareaNotes = editReservationModal.querySelector('#edit_reservation_notes');
            // NEW: Select new input fields
            var modalBodyInputEvent = editReservationModal.querySelector('#edit_reservation_event');
            var modalBodyInputRoom = editReservationModal.querySelector('#edit_reservation_room');
            var modalBodyInputGuests = editReservationModal.querySelector('#edit_reservation_guests');

            var editForm = editReservationModal.querySelector('#editReservationForm');

            modalTitle.textContent = "{{ _('reservations.edit_modal_title') }}: " + reservationId + " - " + customerName;
            modalBodyInputId.value = reservationId;
            
            // Set the search input and hidden ID for customer
            modalBodyInputCustomerSearch.value = customerName;
            modalBodyInputCustomerSearch.dataset.selectedCustomerName = customerName; // Store original name
            modalBodyInputCustomerIdHidden.value = customerId;

            modalBodySelectStoreId.value = storeId;
            modalBodyInputDatetime.value = reservationDatetime;
            modalBodySelectStatus.value = reservationStatus;
            modalBodyTextareaNotes.value = reservationNotes;
            // NEW: Populate new input fields
            modalBodyInputEvent.value = reservationEvent;
            modalBodyInputRoom.value = reservationRoom;
            modalBodyInputGuests.value = reservationGuests;

            editForm.action = "{{ url_for('edit_reservation', reservation_id=0) }}".replace('0', reservationId);
        });
    });
</script>
{% endblock %}